<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>酷狗音乐播放</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <script type="text/javascript" src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript"  src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <style>
        .lineheight{
            color:lightskyblue;
        }
        .lyric{
            float:right;
            margin-right:8%;
        }
        h1,h4{
            text-align: center;
            color:blue;
            text-shadow: 0 0 0.2em #87F
        }
        li{
            line-height: 40px;
            font-size:18px;
            text-shadow: 0 0 0.2em #87F;
        }
    </style>

</head>
<body>

<input type="button" class="btn btn-primary" onclick="audioplay()" value="播放">
<audio controls preload="auto" autoplay loop="loop">
    <source id="source">
</audio>

<textarea id="lrc_content" name="textfield" cols="70" rows="10" style="display:none;">
</textarea>

<div class="lyric">
<ul id="text" style="overflow: hidden;">
    <h1 id="songnametitle"></h1>
    <h4 id="artistnametitle"></h4>
    <h4 id="albumnametitle"></h4>
</ul>
</div>

<script>

    var filehash = window.localStorage.getItem("filehashkey");//musicid
    var musicid = window.localStorage.getItem("kugoumusicidkey");
    var singerid = window.localStorage.getItem("kugousingeridkey");
    var songname = window.localStorage.getItem("kugousongnamekey");
    var artistname = window.localStorage.getItem("kugouartistnamekey");

    var kugousongnametitle=window.localStorage.getItem("kugousongnametitlekey");
    var kugouartistnametitle=window.localStorage.getItem("kugouartistnametitlekey");
    var kugoualbumnametitle=window.localStorage.getItem("kugoualbumnametitlekey");
    var userid=window.localStorage.getItem("IDkey");

    window.onload=function()
    {
        $.ajax({
            type: 'GET',
            url: 'http://129.204.223.158/kugou/songurl?hash='+filehash,
            async: false,
            success: function (data1) {
                var LRC=data1.data.lyrics;
                $('#songnametitle').html(kugousongnametitle);
                $('#artistnametitle').html(kugouartistnametitle);
                $('#albumnametitle').html('专辑: '+kugoualbumnametitle);
                $('#lrc_content').html(LRC);
            }
        })
        ReportBehaviour();
        createLrc();
    }

    var value="Bearer "+window.localStorage.getItem("Tokenkey");
    function audioplay()
    {

        var audio = document.getElementsByTagName("audio")[0];
        console.log(filehash);
        $.ajax({
            type: 'GET',
            url: 'http://129.204.223.158/kugou/songurl?hash='+filehash,
            async: false,
            success: function (data1) {
                var URL = data1.data.play_url;
                    document.getElementById("source").src = URL;
                    audio.setAttribute("src",URL);
                    audio.load();
                }
        })
    }

    var audio = document.getElementsByTagName("audio")[0];
    var medisArray = new Array();   // 定义一个新的数组
    function createLrc () {
        var medis = document.getElementById('lrc_content').innerText;
        var medises = medis.split("\n");    // 用换行符拆分获取到的歌词

        $.each(medises, function (i, item) {    // 遍历medises，并且将时间和文字拆分开，并push进自己定义的数组，形成一个对象数组
            var t = item.substring(item.indexOf("[") + 1, item.indexOf("]"));
            medisArray.push({
                t: (t.split(":")[0] * 60 + parseFloat(t.split(":")[1])).toFixed(3),
                c: item.substring(item.indexOf("]") + 1, item.length)
            });
        });
        var ul = $("#text");
        // 遍历medisArray，并且生成li标签，将数组内的文字放入li标签
        $.each(medisArray, function (i, item) {
            var li = $("<li style='list-style: none;text-align: center'>");
            li.html(item.c);
            ul.append(li);
        });

        var lineNo =0;
        audio.ontimeupdate = function () {
            if (lineNo == medisArray.length - 1 && audio.currentTime.toFixed(3) >= parseFloat(medisArray[lineNo].t)) {
                lineHeight(lineNo);
            }
            if (parseFloat(medisArray[lineNo].t) <= audio.currentTime.toFixed(3) &&
                audio.currentTime.toFixed(3) <= parseFloat(medisArray[lineNo + 1].t)) {
                lineHeight(lineNo);
                lineNo++;
            }
        };
    }

    function lineHeight(lineno)
    {
        var fraction = 0.5;
        var topNum = 0;
        var ul = $("#text");
        var $ul = document.getElementById('text');
        // 令正在唱的那一行高亮显示
        if (lineno > 0) {
            $(ul.find("li").get(topNum + lineno - 1)).removeClass("lineheight");
        }
        var nowline = ul.find("li").get(topNum + lineno);
        $(nowline).addClass("lineheight");

        // 实现文字滚动
        var _scrollTop;
        $ul.scrollTop = 0;
        if ($ul.clientHeight * fraction > nowline.offsetTop) {
            _scrollTop = 0;
        } else if (nowline.offsetTop > ($ul.scrollHeight - $ul.clientHeight * (1 - fraction))) {
            _scrollTop = $ul.scrollHeight - $ul.clientHeight;
        } else {
            _scrollTop = nowline.offsetTop - $ul.clientHeight * fraction;
        }

        //以下声明歌词高亮行固定的基准线位置成为 “A”
        if ((nowline.offsetTop - $ul.scrollTop) >= $ul.clientHeight * fraction) {
            //如果高亮显示的歌词在A下面，那就将滚动条向下滚动，滚动距离为 当前高亮行距离顶部的距离-滚动条已经卷起的高度-A到可视窗口的距离
            $ul.scrollTop += Math.ceil(nowline.offsetTop - $ul.scrollTop - $ul.clientHeight * fraction);

        } else if ((nowline.offsetTop - $ul.scrollTop) < $ul.clientHeight * fraction && _scrollTop != 0) {
            //如果高亮显示的歌词在A上面，那就将滚动条向上滚动，滚动距离为 A到可视窗口的距离-当前高亮行距离顶部的距离-滚动条已经卷起的高度
            $ul.scrollTop -= Math.ceil($ul.clientHeight * fraction - (nowline.offsetTop - $ul.scrollTop));

        } else if (_scrollTop == 0) {
            $ul.scrollTop = 0;
        } else {
            $ul.scrollTop += $(ul.find('li').get(0)).height();
        }
    }

    function ReportBehaviour()
    {
   $.ajax({
       type:'POST',
       url: 'http://129.204.223.158/backend/music/tracking/behaviour',
       contentType:'application/json',
       dataType:'json',
       data:JSON.stringify({
           Userid:userid,
           Behaviour:"listen",
           Time:Math.round(new Date().getTime()/1000),
           Music:{
               Musicid:musicid,
               Name:songname,
               Platform:"kugou",
               Singerid:singerid,
               Singername:artistname,
               },
           Isinplaylist:false,
       }),
       beforeSend: function (request) {
           request.setRequestHeader("Authorization", value);
       },//JWT请求头
       success:function(data)
       {
           console.log(data)
       },
       error:function(error)
       {
           console.log(error);
       }
   })
}



</script>
</body>
</html>